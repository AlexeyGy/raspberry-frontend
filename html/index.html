<!DOCTYPE html>
<html>

<head>
  <!-- from https://www.kirupa.com/html5/accessing_your_webcam_in_html5.htm -->
  <meta charset="utf-8">
  <title>Display Webcam Stream</title>

  <style>
    #container {
      margin: 0px auto;
      width: 500px;
      height: 375px;
      border: 10px #333 solid;
    }

    #videoElement {
      width: 500px;
      height: 375px;
      background-color: #666;
    }
  </style>
</head>

<body>
  <div id="container">
    <video autoplay="true" id="videoElement" controls="controls">

    </video>
  </div>
  <script>
    function sendPayload(blob) {
      const xhr = new XMLHttpRequest();

      const formData = new FormData();
      formData.set('img', blob, 'img');

      xhr.open("POST", 'http://raspberrypi:5000/upload');
      xhr.setRequestHeader('enctype', 'multipart/form-data');

      xhr.addEventListener("load", function () { alert("Done!"); }, false);

      // xhr.send(imageBitmap);
      xhr.send(formData);
    }
    function capture(imageCapture) {
      imageCapture.takePhoto()
        .then(function (blob) {
          console.log('Grabbed frame:', blob);
          sendPayload(blob);
        })
        .catch(function (error) {
          console.log('grabFrame() error: ', error);
        });
    }

    var video = document.querySelector("#videoElement");

    if (navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
          video.srcObject = stream;
          const track = stream.getVideoTracks()[0];
          imageCapture = new ImageCapture(track);
          setInterval(capture, 1000, imageCapture)

        })
        .catch(function (err0r) {
          console.log("Something went wrong!");
        });
    }
  </script>
</body>

</html>
